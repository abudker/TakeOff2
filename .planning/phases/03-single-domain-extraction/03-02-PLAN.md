---
phase: 03-single-domain-extraction
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/agents/project-extractor.md
  - .claude/instructions/project-extractor/instructions.md
  - .claude/instructions/project-extractor/field-guide.md

autonomous: true

must_haves:
  truths:
    - "Project extractor instructions define extraction rules for all ProjectInfo fields"
    - "Project extractor instructions define extraction rules for all EnvelopeInfo fields"
    - "Field guide maps Title 24 document locations to schema fields"
  artifacts:
    - path: ".claude/agents/project-extractor.md"
      provides: "Project extractor agent definition"
      contains: "@.claude/instructions/project-extractor"
    - path: ".claude/instructions/project-extractor/instructions.md"
      provides: "Extraction workflow"
      min_lines: 80
    - path: ".claude/instructions/project-extractor/field-guide.md"
      provides: "Field-to-source mapping"
      contains: ["run_title", "climate_zone", "conditioned_floor_area"]
  key_links:
    - from: ".claude/agents/project-extractor.md"
      to: ".claude/instructions/project-extractor/instructions.md"
      via: "@file reference"
      pattern: "@.*instructions/project-extractor"
    - from: "orchestrator (Plan 03)"
      to: "src/schemas/building_spec.py"
      via: "import ProjectInfo, EnvelopeInfo"
      pattern: "from schemas.building_spec import"
---

<objective>
Create the project extractor agent that extracts ProjectInfo and EnvelopeInfo from Title 24 documents, focusing on project metadata, climate zone, fuel type, and envelope characteristics.

Purpose: Project extraction validates the end-to-end extraction pattern before expanding to zones, windows, and HVAC in Phase 4.

Output: Project extractor agent definition and detailed extraction instructions.
</objective>

<execution_context>
@/Users/Andrew/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Andrew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-single-domain-extraction/03-RESEARCH.md

# Existing patterns
@.claude/agents/verifier.md
@.claude/instructions/verifier/instructions.md

# Schema to extract into
@src/schemas/building_spec.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project extractor agent definition</name>
  <files>.claude/agents/project-extractor.md</files>
  <action>
Create project extractor agent following verifier pattern (thin wrapper):

Create `.claude/agents/project-extractor.md` (under 50 lines):
- Name: project-extractor
- Description: Extracts project metadata and envelope data from Title 24 plans
- Tools: Read (for instructions and images), Bash (for file ops)
- Reference: @.claude/instructions/project-extractor/instructions.md
- Core task: Given page images and document map, extract ProjectInfo + EnvelopeInfo
- Input: Page image paths, DocumentMap JSON (from discovery)
- Output: JSON matching ProjectInfo + EnvelopeInfo schemas

Key points to include:
- Uses document map to focus on schedule and CBECC pages
- Outputs structured JSON matching building_spec.py schemas
- Reports confidence for uncertain extractions
  </action>
  <verify>
```bash
cat /Users/Andrew/Projects/takeoff2/.claude/agents/project-extractor.md | head -30
wc -l /Users/Andrew/Projects/takeoff2/.claude/agents/project-extractor.md
# Should be under 50 lines
```
  </verify>
  <done>Project extractor agent defined under 50 lines with references to instruction files</done>
</task>

<task type="auto">
  <name>Task 2: Create extraction instructions and field guide</name>
  <files>.claude/instructions/project-extractor/instructions.md, .claude/instructions/project-extractor/field-guide.md</files>
  <action>
Create comprehensive extraction instructions:

1. Create `.claude/instructions/project-extractor/instructions.md`:
   - Version header (v1.0.0)
   - Extraction workflow:
     a. Receive page images and document map
     b. Focus on schedule_pages and cbecc_pages from document map
     c. For each relevant page, extract fields using field guide
     d. Merge data from multiple pages (later values override earlier)
     e. Validate against schema constraints
     f. Return JSON matching ProjectInfo + EnvelopeInfo
   - Handling missing data:
     - Required fields: Must be extracted or report error
     - Optional fields: Use null if not found
   - Confidence reporting: Note fields with low confidence in extraction notes
   - Output format: JSON with project and envelope top-level keys

2. Create `.claude/instructions/project-extractor/field-guide.md`:
   Map each schema field to Title 24 document sources:

   **ProjectInfo fields:**
   - run_title: Cover page, title block, or first page header
   - address: Title block, CBECC form header
   - city: Title block, CBECC form
   - climate_zone: CBECC form (look for "Climate Zone" or "CZ"), CF1R header
   - fuel_type: CBECC form ("Fuel Type"), equipment schedules (gas vs electric equipment)
   - house_type: CBECC form ("Building Type" or "Dwelling Type")
   - dwelling_units: CBECC form, typically "1" for ADUs
   - stories: CBECC form, elevation drawings (count floors)
   - bedrooms: CBECC form, floor plan (count bedrooms)

   **EnvelopeInfo fields:**
   - conditioned_floor_area: CBECC form ("Conditioned Floor Area" or "CFA"), floor plan area calculations
   - window_area: Window schedule total, CBECC form fenestration summary
   - window_to_floor_ratio: CBECC form ("WWR"), or calculate from window_area / CFA
   - exterior_wall_area: Wall schedule total, CBECC form envelope summary
   - fenestration_u_factor: Window schedule (area-weighted average), CBECC fenestration

   Include extraction tips:
   - Look for CBECC-Res software outputs (standardized format)
   - CF1R forms contain building summary data
   - Cross-reference values between schedules and CBECC forms
   - Climate zones are 1-16 in California
  </action>
  <verify>
```bash
# Verify instructions exist with key workflow sections
grep -E "(workflow|page images|document map|schema)" /Users/Andrew/Projects/takeoff2/.claude/instructions/project-extractor/instructions.md | head -5

# Verify field guide covers all schema fields
echo "=== ProjectInfo fields ==="
grep -c -E "(run_title|address|city|climate_zone|fuel_type|house_type|dwelling_units|stories|bedrooms)" /Users/Andrew/Projects/takeoff2/.claude/instructions/project-extractor/field-guide.md

echo "=== EnvelopeInfo fields ==="
grep -c -E "(conditioned_floor_area|window_area|window_to_floor_ratio|exterior_wall_area|fenestration_u_factor)" /Users/Andrew/Projects/takeoff2/.claude/instructions/project-extractor/field-guide.md
```
  </verify>
  <done>Instructions define extraction workflow, field guide maps all 14 schema fields to document sources</done>
</task>

</tasks>

<verification>
Overall plan verification:

1. Agent file structure matches pattern:
```bash
ls -la /Users/Andrew/Projects/takeoff2/.claude/agents/project-extractor.md
ls -la /Users/Andrew/Projects/takeoff2/.claude/instructions/project-extractor/
```

2. All ProjectInfo fields documented (9 fields):
```bash
for field in run_title address city climate_zone fuel_type house_type dwelling_units stories bedrooms; do
  grep -l "$field" /Users/Andrew/Projects/takeoff2/.claude/instructions/project-extractor/field-guide.md && echo "Found: $field"
done
```

3. All EnvelopeInfo fields documented (5 fields):
```bash
for field in conditioned_floor_area window_area window_to_floor_ratio exterior_wall_area fenestration_u_factor; do
  grep -l "$field" /Users/Andrew/Projects/takeoff2/.claude/instructions/project-extractor/field-guide.md && echo "Found: $field"
done
```
</verification>

<success_criteria>
- Project extractor agent definition follows thin-wrapper pattern (<50 lines)
- Instructions define clear extraction workflow using document map
- Field guide covers all 9 ProjectInfo fields with document sources
- Field guide covers all 5 EnvelopeInfo fields with document sources
- Ready for orchestrator to invoke extractor with page images and document map
</success_criteria>

<output>
After completion, create `.planning/phases/03-single-domain-extraction/03-02-SUMMARY.md`
</output>
