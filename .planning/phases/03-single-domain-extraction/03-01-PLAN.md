---
phase: 03-single-domain-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/schemas/discovery.py
  - .claude/agents/discovery.md
  - .claude/instructions/discovery/instructions.md

autonomous: true

user_setup:
  - service: anthropic
    why: "Claude API for vision-based document analysis"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys"

must_haves:
  truths:
    - "Discovery agent can classify pages as schedule/cbecc/drawing/other"
    - "DocumentMap schema validates with page numbers and types"
    - "Agent instructions define clear classification criteria for Title 24 documents"
  artifacts:
    - path: "src/schemas/discovery.py"
      provides: "DocumentMap and PageInfo Pydantic models"
      exports: ["DocumentMap", "PageInfo", "PageType"]
    - path: ".claude/agents/discovery.md"
      provides: "Discovery agent definition"
      contains: "@.claude/instructions/discovery"
    - path: ".claude/instructions/discovery/instructions.md"
      provides: "Page classification workflow"
      min_lines: 50
  key_links:
    - from: ".claude/agents/discovery.md"
      to: ".claude/instructions/discovery/instructions.md"
      via: "@file reference"
      pattern: "@.*instructions/discovery"
    - from: "orchestrator (Plan 03)"
      to: "src/schemas/discovery.py"
      via: "import DocumentMap"
      pattern: "from schemas.discovery import"
---

<objective>
Create the discovery agent that scans Title 24 PDFs and maps document structure, identifying schedules, CBECC compliance pages, and architectural drawings.

Purpose: Discovery provides the document map that extractors use to focus on relevant pages, avoiding full-PDF processing and reducing token costs.

Output: DocumentMap schema, discovery agent definition, and classification instructions.
</objective>

<execution_context>
@/Users/Andrew/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Andrew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-single-domain-extraction/03-RESEARCH.md

# Existing patterns to follow
@.claude/agents/verifier.md
@.claude/instructions/verifier/instructions.md
@src/schemas/building_spec.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create discovery schema</name>
  <files>src/schemas/discovery.py, src/schemas/__init__.py</files>
  <action>
Create Pydantic models for document structure mapping:

1. Create `src/schemas/discovery.py`:
   - `PageType` enum: schedule, cbecc, drawing, other
   - `PageInfo` model with fields:
     - page_number: int (1-indexed)
     - page_type: PageType
     - confidence: Literal["high", "medium", "low"]
     - description: Optional[str] (what's on the page)
   - `DocumentMap` model with fields:
     - total_pages: int
     - pages: List[PageInfo]
     - Properties for convenience: schedule_pages, cbecc_pages, drawing_pages (return List[int])

2. Update `src/schemas/__init__.py` to export new models.

Follow existing building_spec.py patterns (Field descriptions, validators).
  </action>
  <verify>
```bash
cd /Users/Andrew/Projects/takeoff2 && python -c "
from schemas.discovery import DocumentMap, PageInfo, PageType
# Create test instance
page = PageInfo(page_number=1, page_type=PageType.SCHEDULE, confidence='high')
doc_map = DocumentMap(total_pages=5, pages=[page])
print(f'PageType values: {[e.value for e in PageType]}')
print(f'DocumentMap schema valid: {doc_map.model_dump()}')
print(f'Schedule pages: {doc_map.schedule_pages}')
"
```
  </verify>
  <done>DocumentMap and PageInfo models importable, schema validates, properties return correct page lists</done>
</task>

<task type="auto">
  <name>Task 2: Create discovery agent with instructions</name>
  <files>.claude/agents/discovery.md, .claude/instructions/discovery/instructions.md</files>
  <action>
Create discovery agent following verifier agent pattern (thin wrapper + external instructions):

1. Create `.claude/agents/discovery.md` (under 50 lines):
   - Name: discovery
   - Description: Maps document structure in Title 24 PDFs
   - Tools: Read (for instructions), Bash (for file ops)
   - Reference: @.claude/instructions/discovery/instructions.md
   - Core task: Classify each page, return DocumentMap JSON

2. Create `.claude/instructions/discovery/instructions.md`:
   - Version header (v1.0.0)
   - Classification criteria for Title 24 documents:
     - **schedule**: Equipment schedules (HVAC, water heater), door/window schedules, finish schedules, plumbing fixtures. Look for: tables with columns, "SCHEDULE" in headers, equipment specifications.
     - **cbecc**: CBECC-Res compliance forms, CF1R/CF2R pages, energy calculations, Title 24 certificates. Look for: "CBECC", "CF1R", "CF2R", "Certificate of Compliance", energy budget tables.
     - **drawing**: Floor plans, elevations, sections, details, site plans. Look for: architectural drawings, dimension lines, room labels, north arrows.
     - **other**: Cover pages, general notes, specifications text, legends.
   - Confidence levels:
     - high: Clear identifying markers (e.g., "SCHEDULE" header, CBECC logo)
     - medium: Page type clear from content but no explicit markers
     - low: Ambiguous content, best guess
   - Output format: JSON matching DocumentMap schema
   - Include example classification for reference
  </action>
  <verify>
```bash
# Verify agent file structure
cat /Users/Andrew/Projects/takeoff2/.claude/agents/discovery.md | head -30
wc -l /Users/Andrew/Projects/takeoff2/.claude/agents/discovery.md

# Verify instructions exist with key sections
grep -E "(schedule|cbecc|drawing|confidence)" /Users/Andrew/Projects/takeoff2/.claude/instructions/discovery/instructions.md | head -10
```
  </verify>
  <done>Discovery agent under 50 lines, instructions contain classification criteria for all page types and confidence levels</done>
</task>

</tasks>

<verification>
Overall plan verification:

1. Schema imports work:
```bash
cd /Users/Andrew/Projects/takeoff2 && python -c "from schemas.discovery import DocumentMap, PageInfo, PageType; print('Schema OK')"
```

2. Agent file structure matches verifier pattern:
```bash
ls -la /Users/Andrew/Projects/takeoff2/.claude/agents/discovery.md
ls -la /Users/Andrew/Projects/takeoff2/.claude/instructions/discovery/
```

3. All required page types documented:
```bash
grep -c -E "schedule|cbecc|drawing|other" /Users/Andrew/Projects/takeoff2/.claude/instructions/discovery/instructions.md
```
</verification>

<success_criteria>
- DocumentMap schema validates with PageInfo entries
- Discovery agent definition follows thin-wrapper pattern (<50 lines)
- Instructions cover all four page types with clear criteria
- Confidence levels defined for classification certainty
- Ready for orchestrator to invoke discovery and receive DocumentMap
</success_criteria>

<output>
After completion, create `.planning/phases/03-single-domain-extraction/03-01-SUMMARY.md`
</output>
