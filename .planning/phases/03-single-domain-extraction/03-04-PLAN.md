---
phase: 03-single-domain-extraction
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - src/agents/__init__.py
  - src/agents/discovery.py
  - src/agents/extractors/__init__.py
  - src/agents/extractors/base.py
  - src/agents/extractors/project.py
  - src/agents/orchestrator.py
  - src/agents/cli.py
  - pyproject.toml

autonomous: true

must_haves:
  truths:
    - "User can run extraction on a single eval with one CLI command"
    - "Discovery agent is invoked as Claude Code agent (not direct API)"
    - "Project extractor is invoked as Claude Code agent (not direct API)"
    - "No ANTHROPIC_API_KEY required - runs within Claude Code"
    - "Extraction output is BuildingSpec JSON saved to eval directory"
  artifacts:
    - path: "src/agents/orchestrator.py"
      provides: "Claude Code agent invocation via subprocess"
      exports: ["run_extraction"]
      contains: "claude"
    - path: "src/agents/cli.py"
      provides: "CLI entry point"
      exports: ["cli"]
  key_links:
    - from: "src/agents/orchestrator.py"
      to: ".claude/agents/discovery.md"
      via: "claude agent invoke"
      pattern: "discovery"
    - from: "src/agents/orchestrator.py"
      to: ".claude/agents/project-extractor.md"
      via: "claude agent invoke"
      pattern: "project-extractor"
    - from: "pyproject.toml"
      to: "src/agents/cli.py"
      via: "extractor CLI entry point"
      pattern: 'extractor = "agents.cli:cli"'
---

<objective>
Rewrite the extraction orchestrator to invoke Claude Code agents instead of direct Anthropic API calls.

Purpose: Align with project architecture - agents defined in `.claude/agents/` should be invoked via Claude Code, not via separate API keys.

Output: Working `extractor extract-one` command that invokes Claude Code agents and produces BuildingSpec JSON.
</objective>

<execution_context>
@/Users/Andrew/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Andrew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-single-domain-extraction/03-01-SUMMARY.md
@.planning/phases/03-single-domain-extraction/03-02-SUMMARY.md

# Agent definitions to invoke
@.claude/agents/discovery.md
@.claude/agents/project-extractor.md

# Schemas
@src/schemas/building_spec.py
@src/schemas/discovery.py

# Current (wrong) implementation to replace
@src/agents/orchestrator.py
@src/agents/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite orchestrator to invoke Claude Code agents</name>
  <files>src/agents/orchestrator.py, src/agents/discovery.py, src/agents/extractors/project.py, src/agents/extractors/base.py</files>
  <action>
Replace direct Anthropic API calls with Claude Code agent invocation:

1. **Delete or gut the direct API modules** - Remove anthropic SDK usage from:
   - `src/agents/discovery.py` - Remove run_discovery that calls Anthropic
   - `src/agents/extractors/project.py` - Remove run_project_extractor that calls Anthropic
   - `src/agents/extractors/base.py` - Can keep utility functions, remove API-specific code

2. **Rewrite `src/agents/orchestrator.py`** to use Claude Code:

   The key insight: When running `extractor extract-one`, we're in a CLI context outside Claude Code. The CLI should invoke Claude Code via subprocess to run the agents.

   ```python
   import subprocess
   import json
   from pathlib import Path

   def invoke_claude_agent(agent_name: str, prompt: str, timeout: int = 300) -> str:
       """
       Invoke a Claude Code agent via subprocess.

       Args:
           agent_name: Name of agent (e.g., "discovery", "project-extractor")
           prompt: Prompt to send to the agent
           timeout: Max seconds to wait

       Returns:
           Agent's response text
       """
       cmd = [
           "claude",
           "--agent", agent_name,
           "--print",  # Output response to stdout
           "--no-interactive",
           prompt
       ]
       result = subprocess.run(cmd, capture_output=True, text=True, timeout=timeout)
       if result.returncode != 0:
           raise RuntimeError(f"Agent {agent_name} failed: {result.stderr}")
       return result.stdout
   ```

   **Flow:**
   a. `run_extraction(eval_name, eval_dir)`:
      1. Find preprocessed images
      2. Build discovery prompt with image paths
      3. Invoke `discovery` agent → get DocumentMap JSON
      4. Parse DocumentMap, filter to relevant pages
      5. Build extraction prompt with relevant page paths + document map
      6. Invoke `project-extractor` agent → get ProjectInfo + EnvelopeInfo JSON
      7. Merge into BuildingSpec, return

   **IMPORTANT:** Remove LangGraph dependency - simple sequential calls are fine for this use case.

3. **Update agent prompts** to include page paths:
   - Discovery prompt: List all page image paths, ask for DocumentMap JSON
   - Extractor prompt: Include document map, list relevant page paths, ask for extraction JSON
  </action>
  <verify>
```bash
# Check anthropic import removed
grep -r "import anthropic" src/agents/ || echo "No anthropic imports (good)"
grep -r "from anthropic" src/agents/ || echo "No anthropic imports (good)"

# Check langgraph removed
grep -r "langgraph" src/agents/ || echo "No langgraph (good)"

# Check claude invocation exists
grep -l "claude" src/agents/orchestrator.py && echo "Claude invocation found"
```
  </verify>
  <done>Orchestrator invokes Claude Code agents via subprocess, no direct Anthropic API</done>
</task>

<task type="auto">
  <name>Task 2: Update CLI and dependencies</name>
  <files>src/agents/cli.py, pyproject.toml</files>
  <action>
1. **Update `src/agents/cli.py`:**
   - Keep the same CLI interface (extract-one, extract-all)
   - Just call the updated orchestrator.run_extraction()
   - The orchestrator now handles Claude Code agent invocation
   - Add helpful error messages if claude CLI not found

2. **Update `pyproject.toml`:**
   - REMOVE: langgraph>=0.2.75 (no longer needed)
   - REMOVE: anthropic>=0.45 (no longer needed - Claude Code handles API)
   - KEEP: click, pyyaml (for CLI)
   - KEEP: pydantic (for schemas)
  </action>
  <verify>
```bash
# Check CLI still works
cd /Users/Andrew/Projects/takeoff2 && pip install -e . && extractor --help

# Verify no anthropic/langgraph in dependencies
grep -E "anthropic|langgraph" pyproject.toml || echo "Dependencies removed (good)"
```
  </verify>
  <done>CLI works, anthropic/langgraph dependencies removed</done>
</task>

<task type="auto">
  <name>Task 3: Test Claude Code agent invocation</name>
  <files></files>
  <action>
Test that Claude Code agents can be invoked:

1. **Verify claude CLI is available:**
   ```bash
   which claude
   claude --version
   ```

2. **Test discovery agent invocation** (dry run with single page):
   ```bash
   # This should work if claude CLI is installed
   claude --agent discovery --print "Test: classify this page as schedule/cbecc/drawing/other"
   ```

3. **Document the invocation pattern** in a comment at the top of orchestrator.py

Note: Full extraction test requires preprocessed images. The CLI structure is verified, actual extraction happens when user runs `extractor extract-one`.
  </action>
  <verify>
```bash
# Check claude is available
which claude && echo "Claude CLI found"

# Check orchestrator imports work
cd /Users/Andrew/Projects/takeoff2 && python -c "from agents.orchestrator import run_extraction; print('Imports OK')"
```
  </verify>
  <done>Claude Code agent invocation verified, orchestrator imports work</done>
</task>

</tasks>

<verification>
Overall plan verification:

1. No direct Anthropic API usage:
```bash
grep -r "anthropic" src/agents/*.py || echo "Clean"
```

2. Claude Code invocation in orchestrator:
```bash
grep "claude" src/agents/orchestrator.py | head -5
```

3. CLI still functional:
```bash
extractor extract-one --help
```

4. Dependencies cleaned up:
```bash
grep -E "anthropic|langgraph" pyproject.toml || echo "Removed"
```
</verification>

<success_criteria>
- extractor CLI runs without ANTHROPIC_API_KEY
- Orchestrator invokes Claude Code agents via subprocess
- No direct Anthropic SDK or LangGraph dependencies
- BuildingSpec JSON produced from agent outputs
- Architecture matches PROJECT.md description
</success_criteria>

<output>
After completion, create `.planning/phases/03-single-domain-extraction/03-04-SUMMARY.md`
</output>
