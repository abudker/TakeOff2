---
phase: 06-automated-improvement-loop
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/improvement/cli.py
  - src/improvement/__init__.py
autonomous: true

must_haves:
  truths:
    - "User can run `python3 -m improvement loop` to start automated improvement loop"
    - "User can run `python3 -m improvement loop --resume-from N` to resume from a specific iteration"
    - "User can run `python3 -m improvement history` to see iteration history with F1 progression"
    - "Loop respects --max-iterations, --target-f1, --patience, --focus flags"
    - "History command shows tabular output with iteration number, F1, delta, status, and best iteration highlighted"
  artifacts:
    - path: "src/improvement/cli.py"
      provides: "loop and history Click commands added to existing CLI group"
      contains: "def loop"
    - path: "src/improvement/__init__.py"
      provides: "Updated exports including loop and history modules"
  key_links:
    - from: "src/improvement/cli.py"
      to: "src/improvement/loop.py"
      via: "loop command instantiates ImprovementLoop and calls run()"
      pattern: "ImprovementLoop"
    - from: "src/improvement/cli.py"
      to: "src/improvement/history.py"
      via: "history command loads IterationHistory and displays table"
      pattern: "IterationHistory"
---

<objective>
Add `loop` and `history` CLI commands to the existing improvement CLI, wiring up the loop controller and history modules from Plan 01.

Purpose: Users need CLI entry points to start/resume the automated loop and inspect iteration history. These commands are the user-facing interface to the automation engine built in Plan 01.

Output: Two new Click commands in the existing cli.py, plus updated __init__.py exports.
</objective>

<execution_context>
@/Users/Andrew/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Andrew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-automated-improvement-loop/06-RESEARCH.md
@.planning/phases/06-automated-improvement-loop/06-01-SUMMARY.md

Key existing code:
@src/improvement/cli.py - Existing CLI group with improve, apply, rollback, context commands
@src/improvement/loop.py - ImprovementLoop class (from Plan 01)
@src/improvement/history.py - IterationHistory class (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add loop command to CLI</name>
  <files>src/improvement/cli.py</files>
  <action>
Add a `loop` command to the existing Click CLI group in cli.py. This command creates an ImprovementLoop instance and calls run() or resume().

**Command signature:**
```python
@cli.command()
@click.option("--evals-dir", type=click.Path(...), default=Path("evals"))
@click.option("--max-iterations", type=int, default=50, help="Maximum iterations to run")
@click.option("--target-f1", type=float, default=0.90, help="Target F1 score")
@click.option("--patience", type=int, default=5, help="Stop after N iterations without improvement")
@click.option("--min-improvement", type=float, default=0.005, help="Minimum F1 delta for improvement")
@click.option("--focus", type=str, default=None, help="Focus critic on specific agent")
@click.option("--focus-reason", type=str, default=None, help="Reason for focus constraint")
@click.option("--no-commit", is_flag=True, help="Skip git commits")
@click.option("--resume-from", type=int, default=None, help="Resume from specific iteration number")
def loop(evals_dir, max_iterations, target_f1, patience, min_improvement, focus, focus_reason, no_commit, resume_from):
```

**Implementation:**
1. Import ImprovementLoop from .loop
2. Instantiate with all parameters
3. If resume_from is specified, call loop_instance.resume(resume_from)
4. Otherwise call loop_instance.run()
5. Wrap in try/except for KeyboardInterrupt (print message, exit 0) and Exception (print error, exit 1)

**Docstring:**
```
Run automated improvement loop until convergence.

Automatically runs critic -> apply -> extract -> verify cycles until:
- Target F1 is reached (default: 0.90)
- Max iterations hit (default: 50)
- Plateau detected (no improvement for --patience iterations)
- 3 consecutive failures occur

Use --resume-from to continue from a previous iteration.
Use --focus to constrain critic to a specific extractor.

Examples:
    python3 -m improvement loop
    python3 -m improvement loop --target-f1 0.85 --max-iterations 20
    python3 -m improvement loop --focus zones-extractor --patience 3
    python3 -m improvement loop --resume-from 10
```
  </action>
  <verify>
Run: `python3 -m improvement --help` -- should show loop command in list.
Run: `python3 -m improvement loop --help` -- should show all options with defaults.
  </verify>
  <done>loop command exists in CLI with all options, wired to ImprovementLoop.run() and .resume().</done>
</task>

<task type="auto">
  <name>Task 2: Add history command to CLI</name>
  <files>src/improvement/cli.py, src/improvement/__init__.py</files>
  <action>
Add a `history` command to the CLI that displays iteration history in a Rich table.

**Command signature:**
```python
@cli.command()
@click.option("--evals-dir", type=click.Path(...), default=Path("evals"))
@click.option("--last", type=int, default=None, help="Show only last N iterations")
def history(evals_dir, last):
```

**Implementation:**
1. Import IterationHistory from .history
2. Load history from `evals_dir.parent / ".improvement-history.json"`
3. If no iterations, print "No iteration history found." and exit
4. Create Rich Table with columns: #, F1, Delta, Precision, Recall, Status, Proposal Target
5. For each iteration (or last N if --last specified):
   - Show iteration number
   - Show F1 with color (green if best, red if decreased from previous)
   - Show F1 delta from previous iteration (first iteration shows "-")
   - Show precision and recall
   - Show status (success/failed) with color
   - Show proposal target_file basename (or "-" if no proposal)
6. Highlight the best iteration row
7. After table, show summary: total iterations, best F1, current F1, stop reason if loop has finished

Also update `src/improvement/__init__.py` to import the new modules:
```python
from .loop import ImprovementLoop
from .history import IterationHistory
```
  </action>
  <verify>
Run: `python3 -m improvement history --help` -- should show options.
Run: `python3 -m improvement --help` -- should list improve, loop, history, apply, rollback, context commands.
  </verify>
  <done>history command displays iteration history as Rich table with F1 progression, deltas, and best iteration highlighted. __init__.py exports updated.</done>
</task>

</tasks>

<verification>
1. `python3 -m improvement --help` lists all 6 commands: improve, loop, history, apply, rollback, context
2. `python3 -m improvement loop --help` shows all options with sensible defaults
3. `python3 -m improvement history --help` shows --last and --evals-dir options
4. No import errors when running any help command
</verification>

<success_criteria>
- loop command wired to ImprovementLoop with all configurable parameters
- history command displays Rich table with F1 progression
- resume-from flag supported
- All existing commands (improve, apply, rollback, context) still work
- No duplicate code between loop command and existing improve command
</success_criteria>

<output>
After completion, create `.planning/phases/06-automated-improvement-loop/06-02-SUMMARY.md`
</output>
