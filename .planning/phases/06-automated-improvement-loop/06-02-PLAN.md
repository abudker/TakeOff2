---
phase: 06-automated-improvement-loop
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/improvement/cli.py
autonomous: true

must_haves:
  truths:
    - "User can run automated loop with `python3 -m improvement loop`"
    - "User can set target F1, max iterations, and patience via CLI flags"
    - "User can resume loop from specific iteration"
    - "User can view iteration history"
  artifacts:
    - path: "src/improvement/cli.py"
      provides: "CLI commands for automated loop"
      contains: "def loop"
  key_links:
    - from: "src/improvement/cli.py"
      to: "src/improvement/loop.py"
      via: "ImprovementLoop import"
      pattern: "from .loop import ImprovementLoop"
    - from: "src/improvement/cli.py"
      to: "src/improvement/history.py"
      via: "IterationHistory import"
      pattern: "from .history import IterationHistory"
---

<objective>
Add CLI commands for automated improvement loop execution and iteration history management

Purpose: Provide user-facing commands to run the automated loop (`loop`), resume from a specific iteration (`loop --resume-from`), and view iteration history (`history`).

Output: Updated cli.py with three new commands: `loop`, `history`
</objective>

<execution_context>
@/Users/Andrew/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Andrew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-automated-improvement-loop/06-RESEARCH.md
@src/improvement/cli.py
@src/improvement/loop.py
@src/improvement/history.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Loop Command to CLI</name>
  <files>src/improvement/cli.py</files>
  <action>
Add `loop` command that runs the automated improvement loop.

**Command: loop**
```python
@cli.command()
@click.option(
    "--evals-dir",
    type=click.Path(exists=True, file_okay=False, dir_okay=True, path_type=Path),
    default=Path("evals"),
    help="Directory containing evaluation cases"
)
@click.option(
    "--max-iterations",
    type=int,
    default=100,
    help="Maximum iterations to run"
)
@click.option(
    "--target-f1",
    type=float,
    default=0.90,
    help="Target F1 score to achieve"
)
@click.option(
    "--patience",
    type=int,
    default=5,
    help="Stop if no improvement for N iterations (plateau detection)"
)
@click.option(
    "--min-improvement",
    type=float,
    default=0.005,
    help="Minimum F1 improvement to count as progress"
)
@click.option(
    "--resume-from",
    type=int,
    default=None,
    help="Resume from specific iteration (truncates history after that point)"
)
@click.option(
    "--no-commit",
    is_flag=True,
    help="Don't auto-commit after each iteration"
)
def loop(evals_dir, max_iterations, target_f1, patience, min_improvement, resume_from, no_commit):
    """
    Run automated improvement loop until convergence.

    Automatically runs critic -> apply -> extract -> verify -> commit
    for each iteration until a stop condition is met:

    - Target F1 achieved (default: 0.90)
    - Max iterations reached (default: 100)
    - Plateau detected (no improvement for N iterations)
    - Too many consecutive failures (3)

    Examples:
        python3 -m improvement loop
        python3 -m improvement loop --target-f1 0.85 --max-iterations 50
        python3 -m improvement loop --resume-from 5
    """
```

**Implementation:**
1. Import ImprovementLoop, StopReason from .loop
2. Create ImprovementLoop instance with provided options
3. Set loop.no_commit = no_commit (if ImprovementLoop supports it, or pass to constructor)
4. Call loop.run(resume_from=resume_from)
5. Handle KeyboardInterrupt gracefully (save state, show partial results)
6. Print final summary: stop reason, final F1, iterations run, best iteration

**Error handling:**
- If evals_dir has no results, print helpful message about running extraction first
- If history file exists and no --resume-from, ask user to confirm starting fresh or resuming
  (or just continue from where left off by default)
  </action>
  <verify>
```bash
cd /Users/Andrew/Projects/takeoff2
python3 -m improvement loop --help
# Should show: --max-iterations, --target-f1, --patience, --resume-from, --no-commit options
```
  </verify>
  <done>loop command runs automated improvement loop with configurable target F1, max iterations, patience, and resume capability</done>
</task>

<task type="auto">
  <name>Task 2: Add History Command to CLI</name>
  <files>src/improvement/cli.py</files>
  <action>
Add `history` command that displays iteration history.

**Command: history**
```python
@cli.command()
@click.option(
    "--evals-dir",
    type=click.Path(exists=True, file_okay=False, dir_okay=True, path_type=Path),
    default=Path("evals"),
    help="Directory containing evaluation cases"
)
@click.option(
    "--last",
    type=int,
    default=None,
    help="Show only last N iterations"
)
@click.option(
    "--json",
    "as_json",
    is_flag=True,
    help="Output as JSON"
)
def history(evals_dir, last, as_json):
    """
    Display iteration history for the improvement loop.

    Shows F1 progression, changes made, and identifies best iteration.

    Examples:
        python3 -m improvement history
        python3 -m improvement history --last 10
        python3 -m improvement history --json
    """
```

**Rich table output (default):**
```
Improvement Loop History
========================

| Iter | Timestamp        | F1    | Delta  | Status  | Change Made              |
|------|------------------|-------|--------|---------|--------------------------|
|    1 | 2026-02-04 10:00 | 0.150 | +0.081 | success | walls extraction rules   |
|    2 | 2026-02-04 10:05 | 0.180 | +0.030 | success | window field mapping     |
| *  3 | 2026-02-04 10:10 | 0.210 | +0.030 | success | zone naming convention   |  # * = best
|    4 | 2026-02-04 10:15 | 0.205 | -0.005 | success | hvac extraction          |

Best iteration: 3 (F1: 0.210)
Current iteration: 4
Iterations since improvement: 1
```

**JSON output (--json):**
Just dump the history file content with json.dumps(indent=2)

**No history case:**
Print "No iteration history found. Run 'python3 -m improvement loop' to start."
  </action>
  <verify>
```bash
cd /Users/Andrew/Projects/takeoff2
python3 -m improvement history --help
# Should show: --last, --json options
```
  </verify>
  <done>history command displays iteration history as Rich table or JSON, highlights best iteration, shows F1 progression and deltas</done>
</task>

</tasks>

<verification>
- [ ] `python3 -m improvement loop --help` shows all expected options
- [ ] `python3 -m improvement history --help` shows all expected options
- [ ] Running `python3 -m improvement history` without history file shows helpful message
- [ ] No import errors when loading CLI
</verification>

<success_criteria>
- loop command accepts --max-iterations, --target-f1, --patience, --min-improvement, --resume-from, --no-commit
- history command displays iteration table with F1, delta, status, changes
- history --json outputs raw JSON
- Commands integrate with ImprovementLoop and IterationHistory from plan 01
</success_criteria>

<output>
After completion, create `.planning/phases/06-automated-improvement-loop/06-02-SUMMARY.md`
</output>
