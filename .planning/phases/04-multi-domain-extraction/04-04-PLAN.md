---
phase: 04-multi-domain-extraction
plan: 04
type: execute
wave: 3
depends_on: ["04-03"]
files_modified:
  - src/agents/cli.py
autonomous: true

must_haves:
  truths:
    - "User can run 'extractor extract-all' to extract from all 5 evals"
    - "User can run 'extractor extract-one <eval> --verbose' to see diagnostics"
    - "extract-all outputs summary with per-eval status"
    - "Verbose mode shows extraction_status per domain and conflict count"
  artifacts:
    - path: "src/agents/cli.py"
      provides: "extract-all command and --verbose flag"
      contains: "extract-all"
  key_links:
    - from: "src/agents/cli.py"
      to: "src/agents/orchestrator.py"
      via: "import run_extraction"
      pattern: "from.*orchestrator import"
    - from: "src/agents/cli.py"
      to: "evals/"
      via: "iterates over eval directories"
      pattern: "evals/"
---

<objective>
Extend CLI with extract-all command and verbose diagnostics flag to support running extraction across all 5 evaluation cases.

Purpose: This completes the Phase 4 requirements EXT-07 (full pipeline on single eval) and EXT-08 (extraction on all 5 evals with one command). The verbose flag enables debugging extraction issues.

Output: Updated cli.py with extract-all command that runs extraction on all evals and --verbose flag showing detailed diagnostics.
</objective>

<execution_context>
@/Users/Andrew/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Andrew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-multi-domain-extraction/04-CONTEXT.md

# Current CLI to extend
@src/agents/cli.py

# Orchestrator with run_extraction
@src/agents/orchestrator.py

# Eval manifest for listing cases
@evals/manifest.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add extract-all Command</name>
  <files>src/agents/cli.py</files>
  <action>
Add extract-all command that runs extraction on all evaluation cases.

**1. Read current CLI structure** - Understand existing commands (likely has extract-one)

**2. Add extract-all command:**
```python
@cli.command("extract-all")
@click.option("--verbose", "-v", is_flag=True, help="Show detailed diagnostics")
@click.pass_context
def extract_all(ctx, verbose: bool):
    """Run extraction on all evaluation cases."""
    evals_dir = Path("evals")
    manifest_path = evals_dir / "manifest.yaml"

    if not manifest_path.exists():
        click.echo(f"Error: Manifest not found at {manifest_path}", err=True)
        raise SystemExit(1)

    # Load manifest to get eval list
    import yaml
    with open(manifest_path) as f:
        manifest = yaml.safe_load(f)

    eval_cases = manifest.get("cases", [])
    if not eval_cases:
        click.echo("No evaluation cases found in manifest", err=True)
        raise SystemExit(1)

    click.echo(f"Running extraction on {len(eval_cases)} evaluation cases...")
    click.echo("=" * 60)

    results = []
    for eval_case in eval_cases:
        eval_id = eval_case.get("id") or eval_case.get("name")
        eval_dir = evals_dir / eval_id

        click.echo(f"\n[{eval_id}] Starting extraction...")

        try:
            result = run_extraction(eval_id, eval_dir)

            if result.get("error"):
                click.echo(f"[{eval_id}] FAILED: {result['error']}")
                results.append({"id": eval_id, "status": "failed", "error": result["error"]})
            else:
                building_spec = result.get("building_spec", {})
                extraction_status = building_spec.get("extraction_status", {})
                conflicts = building_spec.get("conflicts", [])

                # Count extracted items
                zones_count = len(building_spec.get("zones", []))
                walls_count = len(building_spec.get("walls", []))
                windows_count = len(building_spec.get("windows", []))
                hvac_count = len(building_spec.get("hvac_systems", []))
                dhw_count = len(building_spec.get("water_heating_systems", []))

                click.echo(f"[{eval_id}] SUCCESS - Zones: {zones_count}, Walls: {walls_count}, Windows: {windows_count}, HVAC: {hvac_count}, DHW: {dhw_count}")

                if verbose:
                    show_diagnostics(eval_id, extraction_status, conflicts)

                # Save extracted.json
                output_path = eval_dir / "extracted.json"
                with open(output_path, "w") as f:
                    json.dump(building_spec, f, indent=2)
                click.echo(f"[{eval_id}] Saved to {output_path}")

                results.append({
                    "id": eval_id,
                    "status": "success",
                    "zones": zones_count,
                    "walls": walls_count,
                    "windows": windows_count,
                    "hvac": hvac_count,
                    "dhw": dhw_count,
                    "conflicts": len(conflicts)
                })

        except Exception as e:
            click.echo(f"[{eval_id}] ERROR: {e}")
            results.append({"id": eval_id, "status": "error", "error": str(e)})

    # Print summary
    click.echo("\n" + "=" * 60)
    click.echo("EXTRACTION SUMMARY")
    click.echo("=" * 60)

    success_count = sum(1 for r in results if r["status"] == "success")
    failed_count = len(results) - success_count

    click.echo(f"Total: {len(results)} | Success: {success_count} | Failed: {failed_count}")

    if verbose:
        click.echo("\nPer-eval results:")
        for r in results:
            if r["status"] == "success":
                click.echo(f"  {r['id']}: {r['zones']}z/{r['walls']}w/{r['windows']}win/{r['hvac']}hvac/{r['dhw']}dhw ({r['conflicts']} conflicts)")
            else:
                click.echo(f"  {r['id']}: {r['status']} - {r.get('error', 'Unknown')}")
```

**3. Add diagnostics helper:**
```python
def show_diagnostics(eval_id: str, extraction_status: Dict, conflicts: List):
    """Show verbose extraction diagnostics."""
    click.echo(f"\n  --- Diagnostics for {eval_id} ---")

    # Per-domain status
    click.echo("  Extraction Status:")
    for domain, status in extraction_status.items():
        if isinstance(status, dict):
            s = status.get("status", "unknown")
            items = status.get("items_extracted", 0)
            retries = status.get("retry_count", 0)
            error = status.get("error", "")

            status_str = f"{domain}: {s} ({items} items)"
            if retries > 0:
                status_str += f" [retried {retries}x]"
            if error:
                status_str += f" [{error[:50]}...]"
            click.echo(f"    {status_str}")

    # Conflicts
    if conflicts:
        click.echo(f"\n  Conflicts ({len(conflicts)}):")
        for c in conflicts[:5]:  # Show first 5
            if isinstance(c, dict):
                field = c.get("field", "unknown")
                item = c.get("item_name", "")
                resolution = c.get("resolution", "")
                click.echo(f"    - {field} ({item}): {resolution}")
        if len(conflicts) > 5:
            click.echo(f"    ... and {len(conflicts) - 5} more")
```

**4. Add --verbose to extract-one if not present:**
Update the existing extract-one command to accept --verbose flag and call show_diagnostics.

**5. Add necessary imports:**
```python
import json
import yaml  # May need: pip install pyyaml
from pathlib import Path
from typing import Dict, List
```

If PyYAML not in dependencies, add to pyproject.toml.
  </action>
  <verify>
    - extractor extract-all --help (shows command and --verbose option)
    - extractor extract-one --help (shows --verbose option)
    - grep "extract-all" src/agents/cli.py
    - grep "verbose" src/agents/cli.py
    - grep "show_diagnostics" src/agents/cli.py
  </verify>
  <done>
    CLI extended with extract-all command that runs extraction on all 5 evals and reports summary. Verbose flag shows per-domain extraction status and conflicts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify End-to-End Pipeline</name>
  <files>None (verification only)</files>
  <action>
Verify the complete extraction pipeline works end-to-end.

**1. Check all components are importable:**
```bash
python -c "from agents.orchestrator import run_extraction; print('orchestrator OK')"
python -c "from agents.cli import cli; print('cli OK')"
python -c "from schemas.building_spec import BuildingSpec, ExtractionStatus; print('schema OK')"
```

**2. Check CLI commands exist:**
```bash
extractor --help
extractor extract-one --help
extractor extract-all --help
```

**3. Check all agent definitions exist:**
```bash
ls .claude/agents/*-extractor.md
# Should show: project, zones, windows, hvac, dhw (5 total)
```

**4. Check instruction files exist:**
```bash
ls .claude/instructions/*/instructions.md
# Should show instructions for: discovery, project-extractor, zones-extractor, windows-extractor, hvac-extractor, dhw-extractor
```

**5. Verify manifest has eval cases:**
```bash
cat evals/manifest.yaml | head -20
```

Note: Actually running extract-all would require Claude Code runtime and preprocessed images, which is outside the scope of this task. The verification confirms all components are in place for execution.
  </action>
  <verify>
    - python -c "from agents.orchestrator import run_extraction; print('OK')"
    - python -c "from agents.cli import cli; print('OK')"
    - ls .claude/agents/*-extractor.md | wc -l (should show 5)
    - ls .claude/instructions/*/instructions.md | wc -l (should show 6)
  </verify>
  <done>
    End-to-end pipeline verified: all components importable, CLI commands exist, all 5 extractor agents defined, all instruction files present.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. CLI has extract-all:
   - extractor extract-all --help works

2. Verbose diagnostics work:
   - extractor extract-one --help shows --verbose

3. All extractors in place:
   - 5 extractor agent files: project, zones, windows, hvac, dhw
   - 6 instruction directories with instructions.md files

4. Phase 4 requirements met:
   - EXT-03: zones-extractor exists
   - EXT-04: windows-extractor exists
   - EXT-05: hvac-extractor exists (includes HVAC and DHW per roadmap)
   - EXT-07: extractor extract-one runs full pipeline
   - EXT-08: extractor extract-all runs on all 5 evals
</verification>

<success_criteria>
- extract-all iterates over all eval cases from manifest.yaml
- Each eval gets extraction result saved to evals/<id>/extracted.json
- Summary shows success/fail count and per-eval item counts
- --verbose shows per-domain extraction status and conflicts
- All Phase 4 requirements (EXT-03, EXT-04, EXT-05, EXT-07, EXT-08) addressed
</success_criteria>

<output>
After completion, create `.planning/phases/04-multi-domain-extraction/04-04-SUMMARY.md`
</output>
