---
phase: 02-document-processing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/preprocessor/__init__.py
  - src/preprocessor/rasterize.py
  - src/preprocessor/cli.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "User can rasterize a single PDF to PNG images with `preprocessor rasterize-one <pdf>`"
    - "User can preprocess all eval PDFs with `preprocessor preprocess-all`"
    - "Preprocessed images are saved to evals/{eval-id}/preprocessed/{pdf-stem}/page-NNN.png"
    - "Images are capped at 1568px longest edge to fit Claude's context budget"
  artifacts:
    - path: "src/preprocessor/rasterize.py"
      provides: "PDF to image conversion logic"
      exports: ["rasterize_pdf"]
    - path: "src/preprocessor/cli.py"
      provides: "CLI entry points for rasterize-one and preprocess-all"
      exports: ["cli", "rasterize_one", "preprocess_all"]
    - path: "pyproject.toml"
      provides: "preprocessor CLI registration and dependencies"
      contains: "preprocessor = \"preprocessor.cli:cli\""
  key_links:
    - from: "src/preprocessor/cli.py"
      to: "src/preprocessor/rasterize.py"
      via: "import rasterize_pdf"
      pattern: "from \\.rasterize import rasterize_pdf"
    - from: "pyproject.toml"
      to: "src/preprocessor/cli.py"
      via: "CLI entry point registration"
      pattern: "preprocessor.*preprocessor\\.cli:cli"
---

<objective>
Implement PDF preprocessing pipeline that converts Title 24 PDFs to Claude-readable image sequences.

Purpose: Enable extraction agents to consume building plans as images within Claude's context window limits. This is required before Phase 3 extraction work can begin.
Output: Working CLI tool (`preprocessor`) with `rasterize-one` and `preprocess-all` commands that produce PNG images at 1568px maximum resolution.
</objective>

<execution_context>
@/Users/Andrew/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Andrew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-document-processing/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement PDF rasterization core</name>
  <files>src/preprocessor/__init__.py, src/preprocessor/rasterize.py</files>
  <action>
Create the preprocessor module with PDF rasterization logic:

1. Create `src/preprocessor/__init__.py` with version string and public exports
2. Create `src/preprocessor/rasterize.py` implementing:

```python
def rasterize_pdf(
    pdf_path: Path,
    output_dir: Path,
    max_longest_edge: int = 1568,
    output_format: str = "png"
) -> list[tuple[Path, int, int]]:
```

Key implementation details (from research):
- Use `pymupdf.open()` to load PDF
- Calculate zoom factor: `zoom = min(max_longest_edge / longest, 1.0)` - never upscale
- Use `page.get_pixmap(matrix=mat, alpha=False)` for rendering (alpha=False forces white background)
- Output filenames: `page-{page_num:03d}.png` (1-indexed, zero-padded)
- Return list of (path, width, height) tuples for token estimation
- Close document after processing to free memory

Add helper function for token estimation:
```python
def estimate_tokens(width: int, height: int) -> int:
    """Estimate Claude token usage: (width * height) / 750"""
    return (width * height) // 750
```
  </action>
  <verify>
```bash
cd /Users/Andrew/Projects/takeoff2
python -c "from preprocessor.rasterize import rasterize_pdf, estimate_tokens; print('imports ok')"
```
  </verify>
  <done>Module imports successfully, rasterize_pdf and estimate_tokens functions defined</done>
</task>

<task type="auto">
  <name>Task 2: Implement CLI and register entry point</name>
  <files>src/preprocessor/cli.py, pyproject.toml</files>
  <action>
Create CLI entry points and update project configuration:

1. Create `src/preprocessor/cli.py` with Click-based CLI:

```python
@click.group()
def cli():
    """Takeoff v2 Preprocessor - PDF rasterization for extraction."""
    pass

@cli.command()
@click.argument('pdf_path', type=click.Path(exists=True, path_type=Path))
@click.option('--output-dir', '-o', type=click.Path(path_type=Path), default=None)
@click.option('--max-edge', '-m', type=int, default=1568)
def rasterize_one(pdf_path, output_dir, max_edge):
    """Rasterize a single PDF to images."""
    # If output_dir not specified: pdf_path.parent / "preprocessed" / pdf_path.stem
    # Print page count and output directory when complete
    # Print total estimated tokens

@cli.command()
@click.option('--evals-dir', type=click.Path(exists=True, path_type=Path), default=Path('evals'))
@click.option('--max-edge', '-m', type=int, default=1568)
@click.option('--force', is_flag=True, help='Regenerate even if preprocessed/ exists')
def preprocess_all(evals_dir, max_edge, force):
    """Preprocess all eval PDFs."""
    # Find all plans.pdf and spec_sheet.pdf in evals/*
    # Skip if preprocessed/ exists (unless --force)
    # Use tqdm for progress
    # Print summary: PDFs processed, total pages, total estimated tokens
```

2. Update `pyproject.toml`:
- Add dependencies: `pymupdf>=1.26`, `pillow>=10.0`, `tqdm>=4.66`
- Add CLI entry point: `preprocessor = "preprocessor.cli:cli"`
- Add preprocessor package to wheel build

3. Install updated dependencies:
```bash
uv pip install -e .
```
  </action>
  <verify>
```bash
cd /Users/Andrew/Projects/takeoff2
# Test single PDF rasterization
preprocessor rasterize-one evals/lamb-adu/plans.pdf
ls evals/lamb-adu/preprocessed/plans/

# Test batch preprocessing
preprocessor preprocess-all --force
ls evals/*/preprocessed/
```
  </verify>
  <done>
- `preprocessor rasterize-one` converts single PDF to PNG sequence
- `preprocessor preprocess-all` processes all eval PDFs
- Images saved to evals/{eval-id}/preprocessed/{pdf-stem}/page-NNN.png
- Output shows page count and estimated token usage
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Single PDF rasterization works:
```bash
preprocessor rasterize-one evals/lamb-adu/plans.pdf
ls evals/lamb-adu/preprocessed/plans/  # Should show page-001.png through page-011.png
```

2. Batch preprocessing works:
```bash
preprocessor preprocess-all
ls evals/*/preprocessed/  # All evals should have preprocessed directories
```

3. Image resolution is correct:
```bash
# Check that longest edge is <= 1568px
python -c "
from PIL import Image
img = Image.open('evals/lamb-adu/preprocessed/plans/page-001.png')
print(f'Size: {img.size}, longest edge: {max(img.size)}')"
# Should print longest edge <= 1568
```

4. Token budget is reasonable:
```bash
# Run with verbose output showing token estimates
preprocessor preprocess-all --force
# Should show total tokens well under 150k for any single PDF
```
</verification>

<success_criteria>
- `preprocessor rasterize-one <pdf>` converts PDF to PNG images
- `preprocessor preprocess-all` processes all 5 eval PDFs (10 PDF files total: plans + spec_sheets)
- Images are saved to `evals/{eval-id}/preprocessed/{pdf-stem}/page-NNN.png`
- All images have longest edge <= 1568px
- CLI provides feedback on pages processed and estimated tokens
- No external dependencies beyond Python packages (no Poppler/ImageMagick)
</success_criteria>

<output>
After completion, create `.planning/phases/02-document-processing/02-01-SUMMARY.md`
</output>
